# シンプル雑貨オンライン Web アプリケーション リリース手順書

## 1. 文書情報

| 項目           | 内容                         |
| :------------- | :--------------------------- |
| **文書名** | シンプル雑貨オンライン Web アプリケーション リリース手順書 |
| **文書バージョン** | 1.0                          |
| **作成日** | 2025年04月14日               |
| **作成者** | (担当者名)                   |
| **最終更新日** | 2025年04月14日               |
| **最終更新者** | (担当者名)                   |

## 2. リリース概要

| 項目                 | 内容                                                                      |
| :------------------- | :------------------------------------------------------------------------ |
| **対象システム** | シンプル雑貨オンライン Web アプリケーション                                             |
| **リリースバージョン** | v1.0.0                                                                    |
| **リリース目的** | 新規サービス開始                                                              |
| **リリース予定日時** | 2025年MM月DD日 HH:MM ～ HH:MM (JST)                                         |
| **想定作業時間** | 約 60 分                                                                  |
| **サービス停止時間** | 約 10 分 (アプリケーション起動・確認時間) ※DB初期化を伴う場合は別途考慮      |
| **リリース対象物** | `simplezakka-1.0.0.jar` (Spring Boot アプリケーション実行可能JARファイル)      |
| **関連ドキュメント** | リリース計画書 Ver.X.X, テスト報告書 Ver.X.X, 運用保守計画書 Ver.X.X            |

## 3. リリース体制

| 役割                 | 氏名       | 所属       | 連絡先 (例: 内線/Chat ID) |
| :------------------- | :--------- | :--------- | :------------------------ |
| **リリース責任者** | (氏名A)    | (開発部)   | 1234 / userA              |
| **作業担当者(App)** | (氏名B)    | (開発部)   | 1235 / userB              |
| **作業担当者(Infra)**| (氏名C)    | (インフラ部)| 1236 / userC              |
| **確認担当者** | (氏名D)    | (開発部)   | 1237 / userD              |
| **ユーザー代表** | (氏名E)    | (企画部)   | 1238 / userE              |

**緊急連絡網:**

1.  問題発生時、作業担当者はリリース責任者に第一報。
2.  リリース責任者は状況を判断し、関係者（Infra担当、確認担当、ユーザー代表など）に連絡・指示。

## 4. 事前準備・確認事項

リリース作業開始前に、以下の項目が完了していることを確認します。チェックボックスにチェックを入れてください。

- [ ] リリース判定会議で、本リリースの実施が承認されていること。
- [ ] 関係部署およびユーザーへのリリース日時、サービス停止時間の告知が完了していること。
- [ ] **リリース対象ファイル**:
  - [ ] `simplezakka-1.0.0.jar` ファイルがビルドされ、指定のリリース用ディレクトリ (`/path/to/release/artifacts/`) に配置されていること。
  - [ ] ファイルのチェックサム（md5sum/sha256sumなど）が開発時のものと一致することを確認。
- [ ] **本番用設定ファイル**:
  - [ ] 本番サーバーの `/path/to/config/` ディレクトリに `application-prod.properties` が配置されていること。
  - [ ] `application-prod.properties` 内の以下の設定値が本番環境用に正しく設定されていることを確認。
    - `server.port=8080` (または本番用ポート)
    - `spring.datasource.url=jdbc:mysql://<本番DBホスト>:<ポート>/zakkadb` (DBの種類、ホスト、ポート、DB名)
    - `spring.datasource.username=<本番DBユーザー>`
    - `spring.datasource.password=<本番DBパスワード>`
    - `spring.jpa.hibernate.ddl-auto=validate` (または `none`) **※`update`や`create`でないこと！**
    - `logging.level.com.example.simplezakka=INFO` (または `WARN`)
    - その他、環境依存の設定項目
- [ ] **データベース**:
  - [ ] 本番データベース (`zakkadb`) が作成済みであること。
  - [ ] 本番データベースのスキーマ（テーブル定義）が、アプリケーション（`@Entity`定義）が要求するものと一致していること。(`ddl-auto=validate` で起動時に検証される)
  - [ ] **【重要】** 本番データベース全体のバックアップが取得されていること。
    - 取得日時: `YYYY年MM月DD日 HH:MM`
    - バックアップ方法: (例: mysqldump コマンド, クラウドDBのスナップショット機能)
    - バックアップファイルの保管場所: `/path/to/db_backup/zakkadb_YYYYMMDD_HHMM.sql.gz`
- [ ] **現行バージョンバックアップ**: (初回リリース時は不要)
  - [ ] 現在本番で稼働中の `simplezakka-current.jar` (または旧バージョンJAR) がバックアップされていること。
    - バックアップ場所: `/path/to/app_backup/simplezakka-vX.Y.Z.jar`
- [ ] **ロールバック手順**:
  - [ ] 本手順書内の「6. ロールバック手順」の内容が最終確認されていること。
  - [ ] ロールバックに必要な旧バージョンのJARファイルとDBバックアップが利用可能であること。
- [ ] **監視ツール**:
  - [ ] リリース作業中の誤報を防ぐため、対象サーバー/アプリケーションに関する監視アラートを一時的に停止する。(担当: インフラ担当 C)

**事前準備完了確認**: リリース責任者 (氏名A) `YYYY年MM月DD日 HH:MM`

## 5. リリース作業手順

**【作業開始】** `YYYY年MM月DD日 HH:MM` (予定) - 責任者 (氏名A) が宣言

| No | 手順                                                               | 担当者     | 確認者     | チェック | 備考/コマンド例 (環境に合わせて要変更)                                                                                                                                                                                                |
| :-: | :----------------------------------------------------------------- | :--------- | :--------- | :------: | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1  | **サービス停止 (告知)** | Infra担当C | 責任者A    |    [ ]   | `simplezakka`は短時間停止想定。メンテナンス画面等あれば表示。ユーザーへの作業開始告知。 |
| 2  | **ロードバランサーから切り離し** | Infra担当C | 作業担当B  |    [ ]   | ※複数台構成の場合                                                                                                                                                                                               |
| 3  | **アプリケーション停止** | App担当B   | 確認担当D  |    [ ]   | サーバーログイン: `ssh user@your-server-ip` <br> プロセス確認: `ps aux \| grep simplezakka` <br> プロセス停止: `kill <プロセスID>` <br> 停止再確認: `ps aux \| grep simplezakka` (何も表示されない)                     |
| 4  | **現行バージョンJARバックアップ** | App担当B   | 確認担当D  |    [ ]   | 初回リリース時はスキップ。`mv /path/to/app/simplezakka-current.jar /path/to/app_backup/simplezakka-vX.Y.Z_$(date +%Y%m%d%H%M).jar`                                                                      |
| 5  | **新バージョンJAR配置** | App担当B   | 確認担当D  |    [ ]   | `cp /path/to/release/artifacts/simplezakka-1.0.0.jar /path/to/app/simplezakka-1.0.0.jar` <br> `ln -sfn simplezakka-1.0.0.jar /path/to/app/simplezakka-current.jar` (シンボリックリンク運用の場合)              |
| 6  | **ファイル整合性確認** | App担当B   | 確認担当D  |    [ ]   | `md5sum /path/to/app/simplezakka-1.0.0.jar` (事前準備時のチェックサムと比較)                                                                                                                               |
| 7  | **設定ファイル確認** | App担当B   | 確認担当D  |    [ ]   | `/path/to/config/application-prod.properties` の内容を再確認 (目視、diffコマンド等)                                                                                                                            |
| 8  | **アプリケーション起動** | App担当B   | 確認担当D  |    [ ]   | `cd /path/to/app` <br> `nohup java -jar simplezakka-current.jar --spring.profiles.active=prod > /path/to/logs/app_$(date +%Y%m%d%H%M).log 2>&1 &`                                                                |
| 9  | **起動ログ確認** | App担当B   | 確認担当D  |    [ ]   | `tail -f /path/to/logs/app_YYYYMMDDHHMM.log` で監視。<br> `Started SimplezakkaApplication in ... seconds` が表示され、`ERROR` ログがないことを確認。Hibernateのスキーマ検証 (`ddl-auto=validate`) エラーがないかも確認。 |
| 10 | **プロセス確認** | App担当B   | 確認担当D  |    [ ]   | `ps aux \| grep simplezakka` でJavaプロセスが起動していることを確認。                                                                                                                                            |
| 11 | **ポストリリース確認 (基本動作)** | 確認担当D  | App担当B   |    [ ]   | 1. ブラウザで `http://<サーバーIP>:8080/` にアクセスし、トップページが表示されること。 <br> 2. API `/api/products` にアクセスし、商品一覧がJSONで返却されること (Postman等でも可)。 <br> 3. 商品詳細ページの表示。                                 |
| 12 | **ポストリリース確認 (主要機能)** | 確認担当D  | App担当B   |    [ ]   | 1. 商品をカートに追加できること。 <br> 2. カート内容が表示・更新・削除できること。 <br> 3. テストユーザー情報で注文を行い、注文完了画面が表示されること。 <br> 4. 本番DBの `orders`, `order_details` テーブルに注文データが記録されていること。 |
| 13 | **ポストリリース確認 (ログ)** | 確認担当D  | App担当B   |    [ ]   | アプリケーションログ (`/path/to/logs/app_YYYYMMDDHHMM.log`) にエラーが出ていないことを再度確認。                                                                                                               |
| 14 | **ポストリリース確認 (監視)** | Infra担当C | 責任者A    |    [ ]   | 監視ツールでCPU、メモリ、応答時間等に異常値がないことを確認。                                                                                                                                              |
| 15 | **ロードバランサーへ組み込み** | Infra担当C | 作業担当B  |    [ ]   | ※複数台構成の場合                                                                                                                                                                                               |
| 16 | **サービス再開 (告知)** | Infra担当C | 責任者A    |    [ ]   | メンテナンス画面解除など。ユーザーへの作業完了告知。                                                                                                                                                           |

## 6. ロールバック手順

**6.1 ロールバック判断基準**

以下のいずれかの状況が発生し、ポストリリース確認担当者および作業担当者が短時間（例: 15分以内）での解決が困難と判断した場合、リリース責任者 (氏名A) がロールバックを決定する。

- アプリケーションが起動しない、または起動後すぐに停止する。
- 主要機能（商品表示、カート、注文など）が全く動作しない、またはエラーが頻発する。
- データの不整合や破損が発生している。
- システムのパフォーマンスが著しく劣化し、サービス提供に支障をきたす。
- 予期せぬ重大なセキュリティ上の問題が発見された。

**6.2 ロールバック作業手順**

| No | 手順                                                         | 担当者     | 確認者     | チェック | 備考/コマンド例 (環境に合わせて要変更)                                                                                                                                  |
| :-: | :----------------------------------------------------------- | :--------- | :--------- | :------: | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1  | **ロールバック開始宣言** | 責任者A    | 全員       |    [ ]   |                                                                                                                                                                         |
| 2  | **サービス停止 (再確認)** | Infra担当C | 責任者A    |    [ ]   | サービスが再開されていた場合、再度停止する (手順5.1, 5.2参照)。                                                                                                          |
| 3  | **新バージョン アプリケーション停止** | App担当B   | 確認担当D  |    [ ]   | 手順5.3 参照。                                                                                                                                                          |
| 4  | **新バージョンJARファイル退避** | App担当B   | 確認担当D  |    [ ]   | `mv /path/to/app/simplezakka-1.0.0.jar /path/to/rollback_artifacts/` <br> `rm /path/to/app/simplezakka-current.jar` (シンボリックリンクの場合)                          |
| 5  | **旧バージョンJARファイル復元** | App担当B   | 確認担当D  |    [ ]   | 手順5.4でバックアップした旧バージョンJARを戻す。<br> `cp /path/to/app_backup/simplezakka-vX.Y.Z_YYYYMMDDHHMM.jar /path/to/app/simplezakka-vX.Y.Z.jar` <br> `ln -sfn simplezakka-vX.Y.Z.jar /path/to/app/simplezakka-current.jar` |
| 6  | **【条件分岐】DBスキーマ変更を行ったか？** | 責任者A    | 全員       |    [ ]   | 今回(v1.0.0)は通常 No。Yesの場合は手順7へ。Noの場合は手順8へ。                                                                                                        |
| 7  | **データベースリストア (またはロールバックSQL実行)** | Infra担当C | App担当B   |    [ ]   | 事前取得したバックアップからリストア or ロールバック用SQLを実行。リストア手順はDB運用手順書参照。                                                                           |
| 8  | **旧バージョン アプリケーション起動** | App担当B   | 確認担当D  |    [ ]   | 手順5.8, 5.9, 5.10 参照。起動するJARは旧バージョン。                                                                                                                 |
| 9  | **旧バージョン 動作確認** | 確認担当D  | App担当B   |    [ ]   | 手順5.11, 5.12, 5.13 の主要項目を実施し、リリース前の状態に戻っていることを確認。                                                                                         |
| 10 | **サービス再開 (告知)** | Infra担当C | 責任者A    |    [ ]   | 手順5.15, 5.16 参照。ロールバックが完了し、旧バージョンでサービス再開した旨を告知。                                                                                       |
| 11 | **ロールバック完了報告** | 責任者A    | 全員       |    [ ]   | 関係者にロールバックが完了したことを報告。                                                                                                                              |

## 7. 作業完了後の対応

- **監視再開**: [ ] (担当: Infra担当C) 一時停止していた監視アラートを有効に戻す。
- **リリース結果報告**: [ ] (担当: 責任者A) リリース作業の結果（成功/ロールバック）、所要時間、発生した問題点などをまとめ、関係者に報告する。
- **振り返り**: [ ] (担当: 全員参加) リリース作業に関する振り返りミーティングを実施し、今回の反省点や改善点を次回リリースに活かす。
